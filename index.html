<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #050509;
      color: #f5f5f5;
      text-align: center;
    }

    h2 {
      margin-bottom: 8px;
    }

    #status {
      margin-bottom: 12px;
      font-size: 14px;
      opacity: 0.9;
      min-height: 1.5em;
    }

    .video-wrapper {
      position: relative;
      display: inline-block;
      max-width: 420px;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
    }

    #canvas {
      width: 100%;
      height: auto;
      display: block;
    }

    #start-btn {
      margin-bottom: 12px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      background: #00c271;
      color: #050509;
      cursor: pointer;
    }

    #start-btn:active {
      transform: scale(0.97);
    }
  </style>
</head>
<body>
  <h2>Сканер QR</h2>
  <p id="status">Нажми кнопку, чтобы запустить камеру</p>

  <button id="start-btn">Запустить камеру</button>

  <div class="video-wrapper">
    <!-- video используем только как источник, его не видно -->
    <video id="video" playsinline autoplay style="display:none;"></video>
    <!-- на этом canvas рисуем и картинку, и рамку -->
    <canvas id="canvas"></canvas>
  </div>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- jsQR (глобальная функция jsQR) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) tg.expand();

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('start-btn');

    const ctx = canvas.getContext('2d');

    let streamStarted = false;
    let lastSentData = null;
    let lastSentAt = 0; // ms

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function logError(e) {
      console.error(e);
      setStatus('Ошибка: ' + (e && e.message ? e.message : e));
    }

    function drawLine(ctx, begin, end) {
      ctx.beginPath();
      ctx.moveTo(begin.x, begin.y);
      ctx.lineTo(end.x, end.y);
      ctx.lineWidth = 4;
      ctx.strokeStyle = "#00ff7f"; // зелёная рамка
      ctx.stroke();
    }

    async function startCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus("Этот браузер не поддерживает камеру.");
        return;
      }

      try {
        setStatus("Запрашиваю доступ к камере...");
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" }
        });

        video.srcObject = stream;
        video.setAttribute("autoplay", true);
        video.setAttribute("playsinline", true);
        video.play();

        streamStarted = true;
        startBtn.style.display = "none";
        setStatus("Камера запущена, наведи на QR-код.");
        requestAnimationFrame(tick);
      } catch (e) {
        logError(e);
      }
    }

    function maybeSendToTelegram(qrText) {
      const now = Date.now();

      // шлём только если:
      // 1) текст поменялся, или
      // 2) прошло больше 1000 мс с прошлого раза
      if (qrText === lastSentData && now - lastSentAt < 1000) {
        return;
      }

      lastSentData = qrText;
      lastSentAt = now;

      try {
        if (tg) {
          tg.sendData(qrText);
        } else {
          console.log("QR:", qrText);
        }
      } catch (e) {
        logError(e);
      }
    }

    function tick() {
      if (!streamStarted) {
        return;
      }

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // подгоняем размер canvas под реальное разрешение камеры
        if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        }

        // сначала рисуем текущий кадр с камеры
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // берём пиксели и ищем QR
        let code = null;
        try {
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
          });
        } catch (e) {
          logError(e);
        }

        if (code) {
          const loc = code.location;

          // рисуем рамку поверх уже нарисованного кадра
          drawLine(ctx, loc.topLeftCorner, loc.topRightCorner);
          drawLine(ctx, loc.topRightCorner, loc.bottomRightCorner);
          drawLine(ctx, loc.bottomRightCorner, loc.bottomLeftCorner);
          drawLine(ctx, loc.bottomLeftCorner, loc.topLeftCorner);

          setStatus("QR найден ✅");

          // постоянно обновляем QR в боте
          maybeSendToTelegram(code.data);
        } else {
          setStatus("Поиск QR-кода...");
        }
      }

      requestAnimationFrame(tick);
    }

    // запуск камеры только по нажатию
    startBtn.addEventListener('click', () => {
      startCamera();
    });
  </script>
</body>
</html>
