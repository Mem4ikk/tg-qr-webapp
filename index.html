<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #050509;
      color: #f5f5f5;
      text-align: center;
    }

    h2 {
      margin-bottom: 8px;
    }

    #status {
      margin-bottom: 12px;
      font-size: 14px;
      opacity: 0.9;
      min-height: 1.5em;
    }

    .video-wrapper {
      position: relative;
      display: inline-block;
      max-width: 420px;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
    }

    #video {
      width: 100%;
      height: auto;
      display: block;
      background: #000;
    }

    #overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    #start-btn {
      margin-bottom: 12px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      background: #00c271;
      color: #050509;
      cursor: pointer;
    }

    #start-btn:active {
      transform: scale(0.97);
    }
  </style>
</head>
<body>
  <h2>Сканер QR</h2>
  <p id="status">Нажми кнопку, чтобы запустить камеру</p>

  <button id="start-btn">Запустить камеру</button>

  <div class="video-wrapper">
    <video id="video" playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <!-- Скрытый canvas для обработки -->
  <canvas id="canvas" style="display:none;"></canvas>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- jsQR (глобальная функция jsQR) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) tg.expand();

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');     // для обработки
    const overlay = document.getElementById('overlay');   // для рамки
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('start-btn');

    const ctx = canvas.getContext('2d');
    const overlayCtx = overlay.getContext('2d');

    let streamStarted = false;

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function logError(e) {
      console.error(e);
      setStatus('Ошибка: ' + (e && e.message ? e.message : e));
    }

    function drawLine(ctx, begin, end) {
      ctx.beginPath();
      ctx.moveTo(begin.x, begin.y);
      ctx.lineTo(end.x, end.y);
      ctx.lineWidth = 4;
      ctx.strokeStyle = "#00ff7f"; // зелёная рамка
      ctx.stroke();
    }

    async function startCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus("Этот браузер не поддерживает камеру.");
        return;
      }

      try {
        setStatus("Запрашиваю доступ к камере...");
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" }
        });
        video.srcObject = stream;
        video.setAttribute("autoplay", true);
        video.setAttribute("playsinline", true);
        video.play();

        streamStarted = true;
        startBtn.style.display = "none";
        setStatus("Камера запущена, наведи на QR-код.");
        requestAnimationFrame(tick);
      } catch (e) {
        logError(e);
      }
    }

    function tick() {
      if (!streamStarted) return;

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        if (canvas.width !== video.videoWidth) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
        }

        overlayCtx.clearRect(0, 0, overlay.width, overlay.height);

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        let code = null;
        try {
          code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
          });
        } catch (e) {
          logError(e);
        }

        if (code) {
          const loc = code.location;
          drawLine(overlayCtx, loc.topLeftCorner, loc.topRightCorner);
          drawLine(overlayCtx, loc.topRightCorner, loc.bottomRightCorner);
          drawLine(overlayCtx, loc.bottomRightCorner, loc.bottomLeftCorner);
          drawLine(overlayCtx, loc.bottomLeftCorner, loc.topLeftCorner);

          setStatus("QR найден, отправляю в бота...");
          const qrText = code.data;

          try {
            if (tg) {
              tg.sendData(qrText);
              tg.close();
            } else {
              alert("QR: " + qrText);
            }
          } catch (e) {
            logError(e);
          }
          return;
        } else {
          setStatus("Поиск QR-кода...");
        }
      }

      requestAnimationFrame(tick);
    }

    // запуск камеры только по нажатию
    startBtn.addEventListener('click', () => {
      startCamera();
    });
  </script>
</body>
</html>
